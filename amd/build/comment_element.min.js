define(["jquery","core/str","core/ajax","core/modal_factory","core/templates","core/fragment","core/modal_events"],function(a,b,c,d,e,f,g){return function(){return{elementselector:null,btnexpandall:null,btncollapseall:null,btnpostreply:null,subjectselector:null,introselector:null,containerselector:null,courseid:null,questionid:null,idnumber:null,dialogue:null,loadingicon:null,lastfocuselement:null,formselector:null,contextId:null,userId:null,langstring:{},deleteDialog:null,posttodelete:null,hasExpanded:!1,canAddPlaceHolder:!0,emptyContent:["<br><p><br></p>","<p><br></p>","<br>",""],numberToShow:5,cmid:null,TEMPLATE_COMMENTS:"mod_studentquiz/comments",TEMPLATE_COMMENT:"mod_studentquiz/comment",ACTION_CREATE:"mod_studentquiz_create_comment",ACTION_CREATE_REPLY:"mod_studentquiz_create_reply",ACTION_GET_ALL:"mod_studentquiz_get_comments",ACTION_EXPAND:"mod_studentquiz_expand_comment",ACTION_DELETE:"mod_studentquiz_delete_comment",ACTION_LOAD_FRAGMENT_FORM:"mod_studentquiz_load_fragment_form",ROOT_COMMENT_VALUE:0,countServerData:[],noCommentSelector:null,lastcurrentcount:0,lasttotal:0,init:function(c){var d=this;d.elementselector=a("#"+a.escapeSelector(c.id)),d.btnexpandall=d.elementselector.find(".studentquiz-comment-expand"),d.btncollapseall=d.elementselector.find(".studentquiz-comment-collapse"),d.postreply=d.elementselector.find("#id_submitbutton"),d.subjectselector=d.elementselector.find(".studentquiz-comment-subject"),d.introselector=d.elementselector.find(".studentquiz-comment-introduction"),d.containerselector=d.elementselector.find(".studentquiz-comment-replies"),d.postcountselector=d.elementselector.find(".studentquiz-comment-postcount"),d.loadingicon=d.elementselector.find(".studentquiz-comment-loading"),d.courseid=c.courseid,d.questionid=parseInt(c.questionid),d.idnumber=c.idnumber,d.formselector=d.elementselector.find(".studentquiz-comment-postform > form"),d.contextId=parseInt(c.contextid),d.userId=parseInt(c.userid),d.numberToShow=parseInt(c.numbertoshow),d.cmid=parseInt(c.cmid),d.countServerData={count:c.count,total:c.total},d.noCommentSelector=d.elementselector.find(".no-comment"),b.get_strings([{key:"required",component:"core"},{key:"deletecomment",component:"mod_studentquiz"},{key:"confirmdeletecomment",component:"mod_studentquiz"},{key:"delete",component:"mod_studentquiz"},{key:"cancel",component:"core"},{key:"reply",component:"mod_studentquiz"},{key:"replies",component:"mod_studentquiz"},{key:"editorplaceholder",component:"mod_studentquiz"},{key:"moderator",component:"mod_studentquiz"},{key:"important_ipud",component:"mod_studentquiz"}]).done(function(a){d.langstring.required=a[0],d.langstring.deletecomment=a[1],d.langstring.confirmdelete=a[2],d.langstring["delete"]=a[3],d.langstring.cancel=a[4],d.langstring.reply=a[5],d.langstring.replies=a[6],d.langstring.editorplaceholder=a[7],d.langstring.moderator=a[8],d.langstring.highlighted=a[9]}),this.initServerRender(),this.bindEvents()},initServerRender:function(){var b=this;b.containerselector;a(".studentquiz-comment-post").each(function(){var c=a(this).data("id"),d=a(this).find("#c"+c),e={id:c,deleted:d.data("deleted"),numberofreply:d.data("numberofreply"),expand:!1,replies:[],ispost:!0,authorid:d.data("authorid")};b.bindCommentEvent(e)}),b.changeWorkingState(!0),b.btncollapseall.hide(),b.btnexpandall.hide(),b.btnexpandall.prop("disabled",!0);var c=b.countServerData.count,d=c.postcount,e=c.totaldelete;0!==d||0!==e?(b.btnexpandall.show(),b.updateCommentCount(d,b.countServerData.total)):b.updateCommentCount(0,0),b.changeWorkingState(!1),b.initBindEditor()},initCommentArea:function(){var a=this;a.changeWorkingState(!0),a.containerselector.empty(),a.btncollapseall.hide(),a.btnexpandall.hide(),a.btnexpandall.prop("disabled",!0),a.postcountselector.empty(),a.loadingicon.show(),a.initBindEditor(),M.util.js_pending(a.ACTION_GET_ALL),a.getComments(a.questionid,a.numberToShow,function(b){var c=a.countCommentAndReplies(b.data),d=c.postcount,e=c.totaldelete;0!==d||0!==e?(a.btnexpandall.show(),a.updateCommentCount(d,b.total),a.renderComment(b.data,!1)):(a.loadingicon.hide(),a.changeWorkingState(!1),a.updateCommentCount(0,0)),M.util.js_complete(a.ACTION_GET_ALL)})},initBindEditor:function(){var a=this,b=setInterval(function(){0!==a.formselector.find(".editor_atto_content").length&&(a.initAttoEditor(a.formselector),clearInterval(b))},500);this.bindEditorEvent(a.formselector)},bindEvents:function(){var a=this;this.btnexpandall.click(function(){a.containerselector.empty(),a.btnexpandall.hide(),a.btncollapseall.show(),a.loadingicon.show(),a.changeWorkingState(!0),a.lastfocuselement=a.btncollapseall,M.util.js_pending(a.ACTION_GET_ALL),a.getComments(a.questionid,0,function(b){var c=a.countCommentAndReplies(b.data),d=c.total;a.updateCommentCount(d,b.total),a.renderComment(b.data,!0),M.util.js_complete(a.ACTION_GET_ALL)})}),this.btncollapseall.click(function(){a.loadingicon.show(),a.btncollapseall.hide(),a.containerselector.empty(),a.btnexpandall.show(),a.lastfocuselement=a.btnexpandall,a.initCommentArea()}),this.formselector.submit(function(a){a.preventDefault()}),this.postreply.click(function(){var b=a.questionid+"_"+a.ROOT_COMMENT_VALUE,c=a.convertFormToJson(a.formselector);if(c.replyto=a.questionid,0===c["message[text]"].length){var d=a.formselector.find(".editor_atto_wrap");return 0===d.length||d.hasClass("error")||(d.addClass("error"),d.prepend('<span id="id_error_message_5btext_5d" class="error" tabindex="0">'+a.langstring.required+"</span>")),!1}return a.changeWorkingState(!0),a.loadingicon.show(),a.createComment({replyto:a.ROOT_COMMENT_VALUE,message:{text:c["message[text]"],format:c["message[format]"]}},function(c){if(setTimeout(function(){a.formselector.trigger("reset"),a.formselector.find("#id_editor_question_"+b+"editable").empty()}),c.replies=[],a.formselector.find("#id_submitbutton").addClass("disabled"),c.important){var d=a.formselector.find("#id_setimportant");d.length&&(d=d.closest("#fitem_id_setimportant, .fitem"),d.length&&d.remove())}a.appendComment(c,a.elementselector.find(".studentquiz-comment-replies"))}),!0})},getComments:function(a,b,d){var e=this;c.call([{methodname:e.ACTION_GET_ALL,args:{questionid:a,cmid:e.cmid,numbertoshow:b},done:function(a){d(a)},fail:function(a){e.showError(a.message)}}])},showError:function(c){var d=this,e=b.get_string("error","core");a.when(e).done(function(a){d.showDialog(a,c),d.changeWorkingState(!1)})},showDialog:function(a,b){var c=this;c.dialogue?(c.dialogue.title.html(a),c.dialogue.body.html(b),c.dialogue.show()):d.create({type:d.types.DEFAULT,title:a,body:b}).done(function(a){c.dialogue=a,c.dialogue.show()})},updateCommentCount:function(c,d){var e=this;d===-1?d=e.lasttotal:e.lasttotal=d,c===-1?c=e.lastcurrentcount:e.lastcurrentcount=c;var f=b.get_string("current_of_total","studentquiz",{current:c,total:d});a(".studentquiz-comment-post").length>0&&e.noCommentSelector.hide(),a.when(f).done(function(a){e.postcountselector.text(a)})},renderComment:function(b,c){var d=this;return b=d.convertForTemplate(b,c),e.render(d.TEMPLATE_COMMENTS,{comments:b}).done(function(c){var e=a(c);d.containerselector.append(e);var f=0;for(f;f<b.length;f++)d.bindCommentEvent(b[f]);d.changeWorkingState(!1),d.loadingicon.hide()}),!1},bindCommentEvent:function(a){var b=this,c=b.containerselector,d=c.find("#post"+a.id),e=0;for(e;e<a.replies.length;e++){var f=a.replies[e];b.bindReplyEvent(f,d)}d.find(".studentquiz-comment-btndelete").click(function(c){b.bindDeleteEvent(a),c.preventDefault()}),d.find(".studentquiz-comment-btnreply").click(function(c){c.preventDefault(),b.getFragmentFormReplyEvent(a)}),d.find(".studentquiz-comment-expandlink").click(function(c){c.preventDefault(),b.bindExpandEvent(a)}),d.find(".studentquiz-comment-collapselink").click(function(c){c.preventDefault(),b.bindCollapseEvent(a)})},bindReplyEvent:function(a,b){var c=this,d=b.find("#post"+a.id);d.find(".studentquiz-comment-btndeletereply").click(function(b){c.bindDeleteEvent(a),b.preventDefault()})},changeWorkingState:function(a){var b=this;a?(b.btnexpandall.prop("disabled",!0),b.btncollapseall.prop("disabled",!0),b.elementselector.find(".studentquiz-comment-btnreport").prop("disabled",!0),b.elementselector.find(".studentquiz-comment-btnreply").prop("disabled",!0),b.elementselector.find(".studentquiz-comment-btnedit").addClass("disabled"),b.elementselector.find(".studentquiz-comment-btnedit").attr("tabindex",-1),b.elementselector.find(".studentquiz-comment-btndelete").prop("disabled",!0),b.elementselector.find(".studentquiz-comment-btndeletereply").prop("disabled",!0),b.elementselector.find(".studentquiz-comment-btnreport").prop("disabled",!0),b.elementselector.find(".studentquiz-comment-btneditreply").addClass("disabled"),b.elementselector.find(".studentquiz-comment-btneditreply").attr("tabindex",-1),b.elementselector.find(".studentquiz-comment-expandlink").css("visibility","hidden"),b.elementselector.find(".studentquiz-comment-collapselink").css("visibility","hidden"),b.deleteDialog&&(b.deleteDialog.getFooter().find('button[data-action="yes"]').prop("disabled",!0),b.deleteDialog.getFooter().find('button[data-action="yesandemail"]').prop("disabled",!0)),b.postreply.prop("disabled",!0)):(b.btnexpandall.prop("disabled",!1),b.btncollapseall.prop("disabled",!1),b.elementselector.find(".studentquiz-comment-btnreport").prop("disabled",!1),b.elementselector.find(".studentquiz-comment-btnreply").prop("disabled",!1),b.elementselector.find(".studentquiz-comment-btnedit").removeClass("disabled"),b.elementselector.find(".studentquiz-comment-btnedit").removeAttr("tabindex"),b.elementselector.find(".studentquiz-comment-btndelete").prop("disabled",!1),b.elementselector.find(".studentquiz-comment-btndeletereply").prop("disabled",!1),b.elementselector.find(".studentquiz-comment-btnreport").prop("disabled",!1),b.elementselector.find(".studentquiz-comment-btneditreply").removeClass("disabled"),b.elementselector.find(".studentquiz-comment-btneditreply").removeAttr("tabindex"),b.elementselector.find(".studentquiz-comment-expandlink").css("visibility","visible"),b.elementselector.find(".studentquiz-comment-collapselink").css("visibility","visible"),b.postreply.prop("disabled",!1),b.deleteDialog&&(b.deleteDialog.getFooter().find('button[data-action="yes"]').prop("disabled",!1),b.deleteDialog.getFooter().find('button[data-action="yesandemail"]').prop("disabled",!1)),b.lastfocuselement&&(b.lastfocuselement.focus(),b.lastfocuselement=null))},countCommentAndReplies:function(a){var b=0,c=0,d=0,e=0;a.constructor!==Array&&(a=[a]);for(var f=0;f<a.length;f++){var g=a[f];0===g.deletedtime?b++:c++;for(var h=0;h<g.replies.length;h++){var i=g.replies[h];0===i.deletedtime?d++:e++}}return{total:b+d,totaldelete:c+e,postcount:b,deletepostcount:c,replycount:d,deletereplycount:e}},expandComment:function(a,b){var d=this;c.call([{methodname:d.ACTION_EXPAND,args:{questionid:d.questionid,cmid:d.cmid,commentid:a},done:function(a){b(a)},fail:function(a){d.showError(a.message)}}])},bindExpandEvent:function(b){var c=this,d=c.elementselector.find("#post"+b.id),f=c.ACTION_EXPAND,g=c.loadingicon.clone().show();c.changeWorkingState(!0),d.find(".ipud_post-replies").append(g),a(c).hide(),M.util.js_pending(f),c.expandComment(b.id,function(g){for(var h=c.convertForTemplate(g,!0),i=0;i<h.replies.length;i++){var j=h.replies[i];j.deleted&&!j.canviewdeleted&&(h.replies.splice(i,1),i--)}var k=d.find(".ipud_post-replies .studentquiz-comment-post").length,l=c.countCommentAndReplies(h).replycount,m=c.lastcurrentcount+l-k,n=c.lasttotal+(h.numberofreply-b.numberofreply);b.deleted&&!h.deleted&&(m++,n++),!b.deleted&&h.deleted&&(m--,n--),m===n&&(c.btnexpandall.hide(),c.btncollapseall.show()),c.updateCommentCount(m,n),e.render(c.TEMPLATE_COMMENT,h).done(function(b){var e=a(b);d.replaceWith(e),c.lastfocuselement=e.find(".studentquiz-comment-collapselink"),c.bindCommentEvent(g),c.changeWorkingState(!1),M.util.js_complete(f)})})},bindCollapseEvent:function(a){var b=this,c=b.elementselector.find("#post"+a.id),d=c.find(".ipud_post-replies .studentquiz-comment-text").length;b.updateCommentCount(b.lastcurrentcount-d,-1),a.numberofreply=d,c.find(".ipud_post-replies").empty(),a.deleted?c.find(".studentquiz-comment-delete-content").html(a.shortcontent):c.find(".studentquiz-comment-text ").html(a.shortcontent),c.find(".studentquiz-comment-collapselink").hide(),c.find(".studentquiz-comment-expandlink").show().focus(),a.expanded=!1},convertForTemplate:function(a,b){var c=!1;a.constructor!==Array&&(a=[a],c=!0);var d=0;for(d;d<a.length;d++){var e=a[d];e.expanded=b;var f=0;for(f;f<e.replies.length;f++){e.replies[f]}}return c?a[0]:a},convertFormToJson:function(b){var c=b.serializeArray(),d={};return a.each(c,function(){d[this.name]=this.value||""}),d},createComment:function(a,b){var d=this;a.questionid=d.questionid,a.cmid=d.cmid,c.call([{methodname:d.ACTION_CREATE,args:a,done:function(a){b(a)},fail:function(b){d.showError(b.message),d.elementselector.find("#post"+a.replyto+" .studentquiz-comment-postfragmentform").empty()}}])},appendComment:function(b,c,d){var f=this;b=f.convertForTemplate(b,!0),d&&(b.ispost=!1),e.render(f.TEMPLATE_COMMENT,b).done(function(e){var g=a(e);c.append(g),f.lastcurrentcount?f.updateCommentCount(f.lastcurrentcount+1,f.lasttotal+1):(f.updateCommentCount(1,1),f.btncollapseall.prop("disabled",!1),f.btncollapseall.show()),d?(f.bindReplyEvent(b,g.parent()),f.lastfocuselement=c.find(".studentquiz-comment-btneditreply")):(f.bindCommentEvent(b),f.lastfocuselement=c.find(".studentquiz-comment-btnedit")),f.loadingicon.hide(),f.changeWorkingState(!1)})},loadFragmentForm:function(a,b){var c=this,d=[];d.replyto=a.id,d.questionid=c.questionid,d.cmid=c.cmid,d.cancelbutton=!0;var g=c.formselector.find(".editor_atto_wrap");0!==g.length&&g.hasClass("error")&&(g.removeClass("error"),g.find("#id_error_message_5btext_5d").remove()),M.util.js_pending(c.ACTION_LOAD_FRAGMENT_FORM),f.loadFragment("mod_studentquiz","commentform",c.contextId,d).done(function(d,f){e.replaceNodeContents(b,d,f),b.find("#id_message"+a.id+"editable").focus(),b.find("form").submit(function(a){a.preventDefault()}),M.util.js_complete(c.ACTION_LOAD_FRAGMENT_FORM),c.bindFragmentFormEvent(b,a)})},bindFragmentFormEvent:function(a,b){var c=this,d=a.find("#id_submitbutton"),e=a.find("form");d.click(function(){var d=c.convertFormToJson(e);if(0===d["message[text]"].length)return!0;var f=c.loadingicon.clone().show();return f.appendTo(a),e.hide(),c.changeWorkingState(!0),c.createReplyComment(a,b,e,d),!0}),c.fragmentFormCancelEvent(e),c.bindEditorEvent(a)},createReplyComment:function(a,b,c,d){var e=this;M.util.js_pending(e.ACTION_CREATE_REPLY),e.createComment({replyto:b.id,questionid:e.questionid,cmid:e.cmid,message:{text:d["message[text]"],format:d["message[format]"]}},function(c){var d=e.elementselector.find("#post"+b.id),f=d.find(".ipud_post-replies");b.numberofreply++;var g=parseInt(d.find(".studentquiz-comment-count-number").text())+1;d.find(".studentquiz-comment-count-number").text(g),d.find(".studentquiz-comment-count-text").html(1===g?e.langstring.reply:e.langstring.replies),a.empty(),c.replies=[],e.appendComment(c,f,!0),M.util.js_complete(e.ACTION_CREATE_REPLY)})},getFragmentFormReplyEvent:function(a){var b=this,c=b.elementselector.find("#post"+a.id),d=c.find(".studentquiz-comment-postfragmentform").first(),e=b.loadingicon.clone().show();d.append(e),b.loadFragmentForm(a,d),b.changeWorkingState(!0)},fragmentFormCancelEvent:function(a){var b=this,c=a.find("#id_cancel");c.click(function(c){c.preventDefault();var d=a.closest(".studentquiz-comment-post");b.lastfocuselement=d.find(".studentquiz-comment-btnreply"),b.changeWorkingState(!1),a.parent().empty()})},bindDeleteEvent:function(b){var c=this;c.posttodelete=b,c.deleteDialog?c.deleteDialog.show():(c.changeWorkingState(!0),d.create({type:d.types.DEFAULT,title:c.langstring.deletecomment,body:c.langstring.confirmdelete,footer:'<button type="button" data-action="yes" title="'+c.langstring.deletecomment+'">'+c.langstring["delete"]+'</button><button type="button" data-action="no" title="'+c.langstring.cancel+'">'+c.langstring.cancel+"</button>"}).done(function(b){c.deleteDialog=b,b.getFooter().find('button[data-action="no"]').click(function(a){a.preventDefault(),b.hide()}),b.getFooter().find('button[data-action="yes"]').click(function(d){d.preventDefault(),M.util.js_pending(c.ACTION_DELETE),c.changeWorkingState(!0),c.deleteComment(c.posttodelete.id,function(d){if(d.success){var f=a("#post"+d.postinfo.id);d.postinfo.replies=[];var g=c.convertForTemplate(d.postinfo,c.posttodelete.expanded);g.ispost=c.posttodelete.ispost,g.ispost||(g.expanded=!0),e.render(c.TEMPLATE_COMMENT,g).done(function(b){var e=a(b);if(!g.ispost){var h=f.parent().closest(".studentquiz-comment-post").find(".studentquiz-comment-totalreply"),i=h.find(".studentquiz-comment-count-number"),j=parseInt(i.text())-1;h.find(".studentquiz-comment-count-number").text(j),h.find(".studentquiz-comment-count-text").html(1===j?c.langstring.reply:c.langstring.replies)}var k=f.find(".ipud_post-replies").clone(!0);f.replaceWith(e),e.find(".ipud_post-replies").replaceWith(k),c.updateCommentCount(c.lastcurrentcount-1,c.lasttotal-1),c.posttodelete.ispost?c.bindCommentEvent(d.postinfo):c.bindReplyEvent(d.postinfo,e.parent()),c.changeWorkingState(!1),M.util.js_complete(c.ACTION_DELETE)})}else c.showError(d.message);b.hide()})}),b.getRoot().on(g.hidden,function(){var b=a("#post"+c.posttodelete.id);c.posttodelete.ispost?b.find(".studentquiz-comment-btndelete").first().focus():b.find(".studentquiz-comment-btndeletereply").first().focus()}),b.getRoot().on(g.shown,function(){c.changeWorkingState(!1)}),b.show(),c.changeWorkingState(!1)}))},deleteComment:function(a,b){var d=this;c.call([{methodname:d.ACTION_DELETE,args:{questionid:d.questionid,cmid:d.cmid,commentid:a},done:function(a){b(a)},fail:function(a){d.showError(a.message)}}])},initAttoEditor:function(a){var b=this,c=125,d=a.find(".editor_atto_content_wrap"),e=a.find(".editor_atto_content"),f=a.find("textarea"),g=a.find(".editor_atto_toolbar");M.util.js_pending("initeditor"),b.addRemovePlaceHolder(e,d,f),a.find(".editor_atto_content, textarea").focus(function(a){b.hasExpanded||(M.util.js_pending("expandeditor"),a.preventDefault(),g.fadeIn(),e.is(":visible")&&e.height()<c&&(e.animate({height:c},200),f.height(c)),f.is(":visible")&&f.height()<c&&(f.animate({height:c},200),e.height(c)),d.attr("data-placeholder",""),f.attr("placeholder",""),b.canAddPlaceHolder=!1,b.hasExpanded=!0,M.util.js_complete("expandeditor"))}),M.util.js_complete("initeditor")},addRemovePlaceHolder:function(a,b,c){var d=this;if(d.canAddPlaceHolder){if(!(d.emptyContent.indexOf(a.html())>-1))return b.attr("data-placeholder",""),c.attr("placeholder",""),void(d.canAddPlaceHolder=!1);b.attr("data-placeholder",d.langstring.editorplaceholder).addClass("force-redraw").removeClass("force-redraw"),c.attr("placeholder",d.langstring.editorplaceholder),setTimeout(function(){d.addRemovePlaceHolder(a,b,c)},250)}},bindEditorEvent:function(b){var c=this,d=Date.now(),e="textchange"+d,f=b.find("#id_submitbutton");f.addClass("disabled");var g=b.find('textarea[id^="id_editor_question_"]');g.on("change",function(){M.util.js_pending(e),c.emptyContent.indexOf(a(this).val())>-1?(f.addClass("disabled"),f.prop("disabled",!0)):(f.removeClass("disabled"),f.prop("disabled",!1)),M.util.js_complete(e)});var h=setInterval(function(){b.find('textarea[id^="id_message"]').trigger("change")},350);setTimeout(function(){clearInterval(h)},5e3)}}}});