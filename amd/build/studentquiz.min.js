define(["jquery","core/ajax"],function(a,b){var c={initialise:function(b,d){var e=".studentquiz_behaviour > .comments .comment_error",f=a(".studentquiz_behaviour .rate .rating .rateable");f.off("click").on("click",function(a){a.preventDefault(),c.addRating(this)}),f.on("keypress",function(a){13!==a.keyCode&&32!==a.keyCode||(a.preventDefault(),c.addRating(this))}),a('input[name="next"], input[name="previous"], input[name="finish"]').off("click").on("click",function(d){var f=a(this),g=!a('.im-controls input[type="submit"]').length||a('.im-controls input[type="submit"]').filter(function(){return this.name.match(/^q.+-submit$/)}).is(":disabled");if(g){var h=a(".rating span").hasClass("star");b&&(h||(a(".studentquiz_behaviour > .rate > .rate_error").removeClass("hide"),a(".studentquiz_behaviour .rate .rating .rateable:first-child").focus())),d.preventDefault(),f.attr("disabled",!0);var i=c.checkHasComment();return i.done(function(c){c?a(e).addClass("hide"):a(e).removeClass("hide"),f.attr("disabled",!1),b&&!h||c!==!0||(f.unbind("click"),f.click())})}return f.submit(),!0})},setFocus:function(){a(document).ready(function(){var b=a("#categoryquestions .iconsort");b&&b.parent().focus()})},addRating:function(b){var c=a(b).attr("data-rate"),d=a(b),e=a(b).closest("form").find(".cmid_field"),f=e.attr("value");a.post(M.cfg.wwwroot+"/mod/studentquiz/save.php",{save:"rate",cmid:f,questionid:a(b).attr("data-questionid"),sesskey:M.cfg.sesskey,rate:c},function(){var b=d.closest(".rating").children("span");b.removeClass("star"),b.addClass("star-empty"),b.each(function(){a(this).attr("data-rate")<=c&&(a(this).removeClass("star-empty"),a(this).addClass("star"))}),a(".studentquiz_behaviour > .rate > .rate_error").addClass("hide")})},checkHasComment:function(){var c=a(".comment-area-form"),d=c.find("input[name='questionid']").val(),e=c.find("input[name='cmid']").val(),f=b.call([{methodname:"mod_studentquiz_has_comments",args:{questionid:parseInt(d),cmid:parseInt(e)}}]);return f[0].then(function(a){return a.exists})}};return c});