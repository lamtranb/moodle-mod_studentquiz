define ("mod_studentquiz/comment_area",["jquery","core/str","core/ajax","core/modal_factory","core/templates","core/fragment","core/modal_events"],function(n,e,o,r,i,d,l){var a={EMPTY_CONTENT:["<br><p><br></p>","<p><br></p>","<br>",""],ROOT_COMMENT_VALUE:0,GET_ALL_VALUE:0,TEMPLATE_COMMENTS:"mod_studentquiz/comments",TEMPLATE_COMMENT:"mod_studentquiz/comment",ACTION_CREATE:"mod_studentquiz_create_comment",ACTION_CREATE_REPLY:"mod_studentquiz_create_reply",ACTION_GET_ALL:"mod_studentquiz_get_comments",ACTION_EXPAND:"mod_studentquiz_expand_comment",ACTION_DELETE:"mod_studentquiz_delete_comment",ACTION_LOAD_FRAGMENT_FORM:"mod_studentquiz_load_fragment_form",ACTION_EXPAND_ALL:"action_expand_all",ACTION_COLLAPSE_ALL:"action_collapse_all",ACTION_RENDER_COMMENT:"action_render_comment",ACTION_APPEND_COMMENT:"action_append_comment",FRAGMENT_FORM_CALLBACK:"commentform",HAS_COMMENT_CLASS:"has-comment",SELECTOR:{CONTAINER:".studentquiz-comment-container",EXPAND_ALL:".studentquiz-comment-expand",COLLAPSE_ALL:".studentquiz-comment-collapse",SUBMIT_BUTTON:"#id_submitbutton",CONTAINER_REPLIES:".studentquiz-container-replies",COMMENT_REPLIES_CONTAINER:".studentquiz-comment-replies",COMMENT_COUNT:".studentquiz-comment-postcount",COMMENT_TEXT:".studentquiz-comment-text",COMMENT_REPLIES_TEXT:".studentquiz-comment-replies .studentquiz-comment-text",LOADING_ICON:".studentquiz-comment-loading",COMMENT_AREA_FORM:"div.comment-area-form",FORM_SELECTOR:".studentquiz-comment-postform > div.comment-area-form",NO_COMMENT:".no-comment",COLLAPSE_LINK:".studentquiz-comment-collapselink",EXPAND_LINK:".studentquiz-comment-expandlink",COMMENT_ITEM:".studentquiz-comment-item",COMMENT_REPLIES_CONTAINER_TO_ITEM:".studentquiz-comment-replies .studentquiz-comment-item",FRAGMENT_FORM:".studentquiz-comment-postfragmentform",BTN_DELETE:".studentquiz-comment-btndelete",BTN_REPLY:".studentquiz-comment-btnreply",BTN_DELETE_REPLY:".studentquiz-comment-btndeletereply",ATTO_EDITOR_WRAP:".editor_atto_wrap",TEXTAREA:"textarea[id^=\"id_editor_question_\"]",COMMENT_COUNT_NUMBER:".studentquiz-comment-count-number",COMMENT_COUNT_TEXT:".studentquiz-comment-count-text",ATTO:{CONTENT_WRAP:".editor_atto_content_wrap",CONTENT:".editor_atto_content",TOOLBAR:".editor_atto_toolbar"},COMMENT_ID:"#comment_",SPAN_COMMENT_ID:"#c",TOTAL_REPLY:".studentquiz-comment-totalreply",COMMENT_FILTER:".studentquiz-comment-filter",COMMENT_FILTER_HIDE:".hide-comment-filter",COMMENT_ERROR:".studentquiz-comment-container .comment-error",BTN_REPORT:".studentquiz-comment-btnreport",COMMENT_FILTER_ITEM:".studentquiz-comment-filter-item",COMMENT_FILTER_NAME:".studentquiz-comment-filter-name",COMMENT_FILTER_TYPE:".studentquiz-comment-filter-type"},get:function get(){return{elementSelector:null,btnExpandAll:null,btnCollapseAll:null,addComment:null,containerSelector:null,questionId:null,dialogue:null,loadingIcon:null,lastFocusElement:null,formSelector:null,contextId:null,userId:null,string:{},deleteDialog:null,deleteTarget:null,numberToShow:5,cmId:null,countServerData:[],lastCurrentCount:0,lastTotal:0,expand:!1,forceCommenting:!1,canViewDeleted:!1,hasComment:!1,referer:null,highlight:0,sortFeature:null,sortable:[],workingState:!1,isNoComment:!1,init:function init(e){var t=this;t.elementSelector=n("#"+n.escapeSelector(e.id));var o=t.elementSelector;t.btnExpandAll=o.find(a.SELECTOR.EXPAND_ALL);t.btnCollapseAll=o.find(a.SELECTOR.COLLAPSE_ALL);t.addComment=o.find(a.SELECTOR.SUBMIT_BUTTON);t.containerSelector=o.find(a.SELECTOR.CONTAINER_REPLIES);t.loadingIcon=o.find(a.SELECTOR.LOADING_ICON);t.formSelector=o.find(a.SELECTOR.FORM_SELECTOR);t.questionId=parseInt(e.questionid);t.contextId=parseInt(e.contextid);t.userId=parseInt(e.userid);t.numberToShow=parseInt(e.numbertoshow);t.cmId=parseInt(e.cmid);t.countServerData={count:e.count,total:e.total};t.expand=e.expand||!1;t.referer=e.referer;t.sortFeature=e.sortfeature;t.sortable=e.sortable;t.string=e.strings;t.forceCommenting=e.forcecommenting;t.canViewDeleted=e.canviewdeleted;t.isNoComment=e.isnocomment;t.initServerRender();t.initBindEditor();t.bindEvents()},initServerRender:function initServerRender(){var e=this;e.changeWorkingState(!0);n(a.SELECTOR.COMMENT_ITEM).each(function(){var t=n(this).data("id"),o=n(this).find(a.SELECTOR.SPAN_COMMENT_ID+t),r=[];if(e.expand){r=o.data("replies")||[]}var i={id:n(this).data("id"),deleted:o.data("deleted"),numberofreply:o.data("numberofreply"),expanded:e.expand,replies:r,root:!0};e.bindCommentEvent(i)});var t=e.expand?e.countServerData.total:e.countServerData.count.commentcount;e.updateCommentCount(t,e.countServerData.total);if(e.expand){e.btnExpandAll.hide();e.btnCollapseAll.show()}else{e.btnExpandAll.show();e.btnCollapseAll.hide()}var o=window.location.search.substring(1),r=e.parseQueryString(o);e.highlight=parseInt(r.highlight)||0;if(0!==e.highlight){var i=n(a.SELECTOR.COMMENT_ID+e.highlight);if(i.length){e.scrollToElement(i)}}e.changeWorkingState(!1)},initBindEditor:function initBindEditor(){var e=this,t=setInterval(function(){if(0!==e.formSelector.find(a.SELECTOR.ATTO.CONTENT).length){e.bindEditorEvent(e.formSelector);clearInterval(t)}},500)},bindEvents:function bindEvents(){var t=this;t.btnExpandAll.click(function(n){n.preventDefault();M.util.js_pending(a.ACTION_EXPAND_ALL);t.changeWorkingState(!0);t.containerSelector.empty();t.btnExpandAll.hide();t.btnCollapseAll.show();t.loadingIcon.show();t.getComments(a.GET_ALL_VALUE).then(function(e){var n=t.countCommentAndReplies(e.data),o=n.total;t.updateCommentCount(o,e.total);t.renderComment(e.data,!0);M.util.js_complete(a.ACTION_EXPAND_ALL);return!0}).fail(function(e){M.util.js_complete(a.ACTION_EXPAND_ALL);t.showError(e.message);return!1})});t.btnCollapseAll.click(function(n){n.preventDefault();M.util.js_pending(a.ACTION_COLLAPSE_ALL);t.changeWorkingState(!0);t.loadingIcon.show();t.btnCollapseAll.hide();t.btnExpandAll.show();t.containerSelector[0].innerHTML="";t.getComments(t.numberToShow).then(function(e){var n=t.countCommentAndReplies(e.data),o=n.commentCount,r=n.totalDelete;if(0!==o||0!==r){t.btnExpandAll.show();t.updateCommentCount(o,e.total);t.renderComment(e.data,!1)}else{t.loadingIcon.hide();t.changeWorkingState(!1);t.updateCommentCount(0,0)}M.util.js_complete(a.ACTION_COLLAPSE_ALL);return!0}).fail(function(e){M.util.js_complete(a.ACTION_COLLAPSE_ALL);t.showError(e.message);return!1})});t.addComment.click(function(o){o.preventDefault();M.util.js_pending(a.ACTION_CREATE);t.changeWorkingState(!0);t.loadingIcon.show();n(a.SELECTOR.COMMENT_ERROR).addClass("hide");n(a.SELECTOR.NO_COMMENT).hide();var e=a.ROOT_COMMENT_VALUE,r=t.questionId+"_"+e,i=t.formSelector,d=t.convertFormToJson(i);if(0===d["message[text]"].length){var l=i.find(a.SELECTOR.ATTO_EDITOR_WRAP);if(0!==l.length&&!l.hasClass("error")){l.addClass("error");l.prepend("<span class=\"error\" tabindex=\"0\">"+t.string.required+"</span>")}return!1}var E={replyto:e,message:{text:d["message[text]"],format:d["message[format]"]}};t.createComment(E).then(function(e){setTimeout(function(){i.trigger("reset");i.find("#id_editor_question_"+r+"editable").empty()});var n=t.convertForTemplate(e,!0);i.find(a.SELECTOR.SUBMIT_BUTTON).addClass("disabled");t.appendComment(n,t.elementSelector.find(a.SELECTOR.CONTAINER_REPLIES),!1);M.util.js_complete(a.ACTION_CREATE);return!0}).fail(function(n){t.handleFailWhenCreateComment(n,E);M.util.js_complete(a.ACTION_CREATE)});return!0});n(a.SELECTOR.COMMENT_FILTER_ITEM).on("click",function(o){o.preventDefault();if(t.workingState){return}var e=t.string.sort.asc,r=t.string.sort.desc,i=n(this).find(a.SELECTOR.COMMENT_FILTER_NAME),d=n(this).find(a.SELECTOR.COMMENT_FILTER_TYPE),l=n(this).data("type"),E=n(this).attr("data-order"),s=n(this).hasClass("current"),T=n(this).attr("data-asc-string"),m=n(this).attr("data-desc-string");E="desc"===E?"asc":"desc";n(this).attr("data-order",E);if(!s){n(this).addClass("current")}if("desc"===E){i.attr("title",T);i.attr("alt",T);d.attr("title",r);d.attr("alt",r)}else{i.attr("title",m);i.attr("alt",m);d.attr("title",e);d.attr("alt",e)}n(a.SELECTOR.COMMENT_FILTER_ITEM).not(this).each(function(){var t=n(this),o=n(this).find(a.SELECTOR.COMMENT_FILTER_NAME),r=n(this).find(a.SELECTOR.COMMENT_FILTER_TYPE),i=n(this).attr("data-asc-string");t.attr("data-order","desc");t.removeClass("filter-asc");t.removeClass("filter-desc");t.removeClass("current");o.attr("title",i);o.attr("alt",i);r.attr("title",e);r.attr("alt",e)});if("desc"===E){n(this).removeClass("filter-asc");n(this).addClass("filter-desc")}else{n(this).removeClass("filter-desc");n(this).addClass("filter-asc")}var C=l+"_"+E;t.setSort(C);if(t.expand){t.btnExpandAll.trigger("click")}else{t.btnCollapseAll.trigger("click")}})},getComments:function getComments(e){var t=this,n=t.getParamsBeforeCallApi({numbertoshow:e,sort:t.sortFeature}),r=o.call([{methodname:a.ACTION_GET_ALL,args:n}]);return r[0]},getParamsBeforeCallApi:function getParamsBeforeCallApi(e){var t=this;e.questionid=t.questionId;e.cmid=t.cmId;return e},showError:function showError(e){var t=this;n.when(t.string.error).done(function(n){t.showDialog(n,e);t.changeWorkingState(!1)})},showDialog:function showDialog(e,t){var n=this,o=n.dialogue;if(o){o.title.html(e);o.body.html(t);o.show();return}r.create({type:r.types.CANCEL,title:e,body:t}).done(function(e){o=e;o.show();o.getRoot().on(l.hidden,{},function(){location.reload()})})},updateCommentCount:function updateCommentCount(t,o){var r=this;if(-1===o){o=r.lastTotal}else{r.lastTotal=o}if(-1===t){t=r.lastCurrentCount}else{r.lastCurrentCount=t}var i=e.get_string("current_of_total","studentquiz",{current:t,total:o}),d=n(a.SELECTOR.NO_COMMENT),l=n(a.SELECTOR.COMMENT_FILTER),E=r.checkEmptyElement(n(a.SELECTOR.CONTAINER_REPLIES));if(0===r.lastCurrentCount&&E&&r.isNoComment){n(a.SELECTOR.CONTAINER_REPLIES).hide();l.hide();d.show()}else{n(a.SELECTOR.CONTAINER_REPLIES).show();d.hide();l.show()}n.when(i).done(function(e){r.elementSelector.find(a.SELECTOR.COMMENT_COUNT).text(e)})},renderComment:function renderComment(e,t){var n=this;M.util.js_pending(a.ACTION_RENDER_COMMENT);e=n.convertForTemplate(e,t);i.render(a.TEMPLATE_COMMENTS,{comments:e}).done(function(t){n.containerSelector[0].innerHTML=t;n.loadingIcon.hide();for(var o=0;o<e.length;o++){n.bindCommentEvent(e[o])}n.changeWorkingState(!1);M.util.js_complete(a.ACTION_RENDER_COMMENT)});return!1},bindCommentEvent:function bindCommentEvent(t){var o=this,r=o.containerSelector.find(a.SELECTOR.COMMENT_ID+t.id),e=0;if(t.root&&t.hasOwnProperty("replies")){for(e;e<t.replies.length;e++){var d=t.replies[e];if(!d.hasOwnProperty("expand")){d.expand=!0}if(!d.hasOwnProperty("root")){d.root=!1}o.bindReplyEvent(d,r)}}r.find(a.SELECTOR.BTN_DELETE).click(function(n){o.bindDeleteEvent(t);n.preventDefault()});r.find(a.SELECTOR.BTN_REPLY).click(function(n){n.preventDefault();o.getFragmentFormReplyEvent(t)});r.find(a.SELECTOR.EXPAND_LINK).click(function(n){n.preventDefault();o.bindExpandEvent(t)});r.find(a.SELECTOR.COLLAPSE_LINK).click(function(n){n.preventDefault();o.bindCollapseEvent(t)});r.find(a.SELECTOR.BTN_REPORT).click(function(t){t.preventDefault();window.location=n(this).data("href")})},bindReplyEvent:function bindReplyEvent(t,o){var r=this,i=o.find(a.SELECTOR.COMMENT_ID+t.id);i.find(a.SELECTOR.BTN_DELETE_REPLY).click(function(n){r.bindDeleteEvent(t);n.preventDefault()});i.find(a.SELECTOR.BTN_REPORT).click(function(t){t.preventDefault();window.location=n(this).data("href")})},changeWorkingState:function changeWorkingState(e){var t=e?"hidden":"visible",n=this;n.workingState=e;n.btnExpandAll.prop("disabled",e);n.btnCollapseAll.prop("disabled",e);n.elementSelector.find(a.SELECTOR.BTN_REPLY).prop("disabled",e);n.elementSelector.find(a.SELECTOR.BTN_DELETE).prop("disabled",e);n.elementSelector.find(a.SELECTOR.BTN_DELETE_REPLY).prop("disabled",e);n.elementSelector.find(a.SELECTOR.BTN_REPORT).prop("disabled",e);n.elementSelector.find(a.SELECTOR.EXPAND_LINK).css("visibility",t);n.elementSelector.find(a.SELECTOR.COLLAPSE_LINK).css("visibility",t);if(n.deleteDialog){n.deleteDialog.getFooter().find("button[data-action=\"yes\"]").prop("disabled",e)}if(e){n.addComment.prop("disabled",e)}else{if(n.lastFocusElement){n.lastFocusElement.focus();n.lastFocusElement=null}}},countCommentAndReplies:function countCommentAndReplies(e){var t=0,n=0,o=0,r=0;if(e.constructor!==Array){e=[e]}for(var d=0,l;d<e.length;d++){l=e[d];if(0==l.deletedtime){t++}else{n++}for(var a=0,E;a<l.replies.length;a++){E=l.replies[a];if(0==E.deletedtime){o++}else{r++}}}return{total:t+o,totalDelete:n+r,commentCount:t,deleteCommentCount:n,replyCount:o,deleteReplyCount:r}},expandComment:function expandComment(e){var t=this,n=t.getParamsBeforeCallApi({commentid:e}),r=o.call([{methodname:a.ACTION_EXPAND,args:n}]);return r[0]},bindExpandEvent:function bindExpandEvent(e){var t=this,o=t.elementSelector.find(a.SELECTOR.COMMENT_ID+e.id),r=a.ACTION_EXPAND;M.util.js_pending(r);t.changeWorkingState(!0);var d=t.loadingIcon.clone().show();o.find(a.SELECTOR.COMMENT_REPLIES_CONTAINER).append(d);n(t).hide();t.expandComment(e.id).then(function(d){var l=t.convertForTemplate(d,!0),E=o.find(a.SELECTOR.COMMENT_REPLIES_CONTAINER_TO_ITEM).length,s=t.countCommentAndReplies(l).replyCount,T=t.lastCurrentCount+s-E,m=t.lastTotal+(l.numberofreply-e.numberofreply);if(e.deleted&&!l.deleted){T++;m++}if(!e.deleted&&l.deleted){T--;m--}if(T===m){t.btnExpandAll.hide();t.btnCollapseAll.show()}t.updateCommentCount(T,m);return i.render(a.TEMPLATE_COMMENT,l).done(function(e){var i=n(e);o.replaceWith(i);t.lastFocusElement=i.find(a.SELECTOR.COLLAPSE_LINK);t.bindCommentEvent(d);t.changeWorkingState(!1);M.util.js_complete(r);return!0})}).fail(function(n){M.util.js_complete(r);t.showError(n.message)})},bindCollapseEvent:function bindCollapseEvent(e){var t=this,n=t.elementSelector.find(a.SELECTOR.COMMENT_ID+e.id),o=n.find(a.SELECTOR.COMMENT_REPLIES_TEXT).length;t.updateCommentCount(t.lastCurrentCount-o,-1);e.numberofreply=o;n.find(a.SELECTOR.COMMENT_REPLIES_CONTAINER).empty();if(e.deleted){n.find(".studentquiz-comment-delete-content").html(e.shortcontent)}else{n.find(a.SELECTOR.COMMENT_TEXT).html(e.shortcontent)}n.find(a.SELECTOR.COLLAPSE_LINK).hide();n.find(a.SELECTOR.EXPAND_LINK).show().focus();e.expanded=!1},convertForTemplate:function convertForTemplate(e,t){var n=this,o=!1;if(e.constructor!==Array){e=[e];o=!0}for(var r=0,d;r<e.length;r++){d=e[r];d.expanded=t;d.canviewdeleted=n.canViewDeleted;if(!d.hasOwnProperty("replies")){d.replies=[]}n.setHasComment(d.hascomment);d.highlight=d.id===n.highlight;if(n.referer&&d.reportlink){d.reportlink=n.buildRefererReportLink(d.reportlink,d.id)}if(d.root){for(var l=0,a;l<d.replies.length;l++){a=d.replies[l];a.expanded=!0;a.canviewdeleted=n.canViewDeleted;if(!a.hasOwnProperty("replies")){a.replies=[]}a.highlight=a.id===n.highlight;if(n.referer&&a.reportlink){a.reportlink=n.buildRefererReportLink(a.reportlink,a.id)}}}}return o?e[0]:e},convertFormToJson:function convertFormToJson(e){var t={};e.find(":input").each(function(){var e=n(this).prop("type"),o=n(this).attr("name");if(("checkbox"===e||"radio"===e)&&this.checked||"button"!==e&&"submit"!==e){t[o]=n(this).val()}});return t},createComment:function createComment(e){var t=this;e=t.getParamsBeforeCallApi(e);var n=o.call([{methodname:a.ACTION_CREATE,args:e}]);return n[0]},appendComment:function appendComment(e,t,o){var r=this;M.util.js_pending(a.ACTION_APPEND_COMMENT);i.render(a.TEMPLATE_COMMENT,e).done(function(i){var d=n(i);t.append(d);if(!r.lastCurrentCount){n(a.SELECTOR.COMMENT_FILTER).removeClass(a.SELECTOR.COMMENT_FILTER_HIDE);r.updateCommentCount(1,1);r.btnExpandAll.prop("disabled",!0);r.btnExpandAll.hide();r.btnCollapseAll.prop("disabled",!1);r.btnCollapseAll.show();r.expand=!0;r.isNoComment=!1}else{r.updateCommentCount(r.lastCurrentCount+1,r.lastTotal+1)}if(o){r.bindReplyEvent(e,d.parent())}else{r.bindCommentEvent(e)}r.loadingIcon.hide();r.changeWorkingState(!1);M.util.js_complete(a.ACTION_APPEND_COMMENT)})},loadFragmentForm:function loadFragmentForm(e,t){var n=this,o=a.ACTION_LOAD_FRAGMENT_FORM;M.util.js_pending(o);var r=n.getParamsBeforeCallApi({replyto:t.id,cancelbutton:!0,forcecommenting:n.forceCommenting}),l=n.formSelector.find(a.SELECTOR.ATTO_EDITOR_WRAP);if(0!==l.length&&l.hasClass("error")){l.removeClass("error");l.find("#id_error_message_5btext_5d").remove()}d.loadFragment("mod_studentquiz",a.FRAGMENT_FORM_CALLBACK,n.contextId,r).done(function(r,d){i.replaceNodeContents(e,r,d);var l="#id_editor_question_"+n.questionId+"_"+t.id+"editable";e.find(l).focus();n.bindFragmentFormEvent(e,t);M.util.js_complete(o)})},bindFragmentFormEvent:function bindFragmentFormEvent(t,n){var o=this,r=t.find(a.SELECTOR.COMMENT_AREA_FORM);t.find(a.SELECTOR.SUBMIT_BUTTON).click(function(i){i.preventDefault();o.changeWorkingState(!0);var e=o.convertFormToJson(r);if(0===e["message[text]"].length){return!0}var d=o.loadingIcon.clone().show();d.appendTo(t);r.hide();o.createReplyComment(t,n,r,e);return!0});o.fragmentFormCancelEvent(r);o.bindEditorEvent(t)},createReplyComment:function createReplyComment(e,t,o,r){var i=this,d={replyto:t.id,message:{text:r["message[text]"],format:r["message[format]"]}};M.util.js_pending(a.ACTION_CREATE_REPLY);i.createComment(d).then(function(o){n(a.SELECTOR.COMMENT_ERROR).addClass("hide");var r=i.elementSelector.find(a.SELECTOR.COMMENT_ID+t.id),d=r.find(a.SELECTOR.COMMENT_REPLIES_CONTAINER);t.numberofreply++;var l=parseInt(r.find(a.SELECTOR.COMMENT_COUNT_NUMBER).text())+1;r.find(a.SELECTOR.COMMENT_COUNT_NUMBER).text(l);r.find(a.SELECTOR.COMMENT_COUNT_TEXT).html(1===l?i.string.reply:i.string.replies);e.empty();var E=i.convertForTemplate(o,!0);i.appendComment(E,d,!0);M.util.js_complete(a.ACTION_CREATE_REPLY);return!0}).fail(function(t){i.handleFailWhenCreateComment(t,d);M.util.js_complete(a.ACTION_CREATE_REPLY)})},handleFailWhenCreateComment:function handleFailWhenCreateComment(t,e){var n=this;n.showError(t.message);var o=a.SELECTOR.COMMENT_ID+e.replyto+" "+a.SELECTOR.FRAGMENT_FORM;n.elementSelector.find(o).empty()},getFragmentFormReplyEvent:function getFragmentFormReplyEvent(e){var t=this,n=t.elementSelector.find(a.SELECTOR.COMMENT_ID+e.id),o=n.find(a.SELECTOR.FRAGMENT_FORM).first(),r=t.loadingIcon.clone().show();o.append(r);t.loadFragmentForm(o,e);t.changeWorkingState(!0)},fragmentFormCancelEvent:function fragmentFormCancelEvent(t){var n=this,o=t.find("#id_cancel");o.click(function(o){o.preventDefault();var e=t.closest(a.SELECTOR.COMMENT_ITEM);n.lastFocusElement=e.find(a.SELECTOR.BTN_REPLY);n.changeWorkingState(!1);t.parent().empty()})},bindDeleteEvent:function bindDeleteEvent(e){var t=this;t.deleteTarget=e;if(t.deleteDialog){t.deleteDialog.show()}else{t.changeWorkingState(!0);r.create({type:r.types.DEFAULT,title:t.string.deletecomment,body:t.string.confirmdeletecomment,footer:"<button class=\"btn btn-primary\" type=\"button\" data-action=\"yes\" title=\""+t.string.deletecomment+"\">"+t.string.deletetext+"</button><button class=\"btn btn-secondary\" type=\"button\" data-action=\"no\" title=\""+t.string.cancel+"\">"+t.string.cancel+"</button>"}).done(function(o){t.deleteDialog=o;o.getFooter().find("button[data-action=\"no\"]").click(function(t){t.preventDefault();o.hide()});o.getFooter().find("button[data-action=\"yes\"]").click(function(r){r.preventDefault();M.util.js_pending(a.ACTION_DELETE);t.changeWorkingState(!0);t.deleteComment(t.deleteTarget.id).then(function(r){if(!r.success){t.showError(r.message);return!0}var d=t.convertForTemplate(r.data,t.deleteTarget.expanded),l=n(a.SELECTOR.COMMENT_ID+d.id),E=1;t.updateCommentCount(t.lastCurrentCount-E,t.lastTotal-E);if(!d.root){d.expanded=!0}i.render(a.TEMPLATE_COMMENT,d).done(function(o){var r=n(o);if(!d.root){var i=l.parent(),E=i.closest(a.SELECTOR.COMMENT_ITEM).find(a.SELECTOR.TOTAL_REPLY),s=E.find(a.SELECTOR.COMMENT_COUNT_NUMBER),T=parseInt(s.text())-1;E.find(a.SELECTOR.COMMENT_COUNT_NUMBER).text(T);E.find(a.SELECTOR.COMMENT_COUNT_TEXT).html(1===T?t.string.reply:t.string.replies)}var m=l.find(a.SELECTOR.COMMENT_REPLIES_CONTAINER).clone(!0);l.replaceWith(r);r.find(a.SELECTOR.COMMENT_REPLIES_CONTAINER).replaceWith(m);if(t.deleteTarget.root){t.bindCommentEvent(e)}else{t.bindReplyEvent(e,r.parent())}t.changeWorkingState(!1);M.util.js_complete(a.ACTION_DELETE)});o.hide();return!0}).fail(function(e){t.showError(e.message);return!1})});o.getRoot().on(l.hidden,function(){var e=n(a.SELECTOR.COMMENT_ID+t.deleteTarget.id);if(t.deleteTarget.root){e.find(a.SELECTOR.BTN_DELETE).first().focus()}else{e.find(a.SELECTOR.BTN_DELETE_REPLY).first().focus()}});o.getRoot().on(l.shown,function(){t.changeWorkingState(!1)});o.show();t.changeWorkingState(!1)})}},deleteComment:function deleteComment(e){var t=this,n=t.getParamsBeforeCallApi({commentid:e}),r=o.call([{methodname:a.ACTION_DELETE,args:n}]);return r[0]},bindEditorEvent:function bindEditorEvent(e){var t=this;M.util.js_pending("init_editor");t.triggerAttoNoContent(e);e.find(a.SELECTOR.ATTO.TOOLBAR).fadeIn();var o="text_change_"+Date.now(),r=e.find(a.SELECTOR.TEXTAREA),i=r.attr("id")+"editable",d=document.getElementById(i),l=new MutationObserver(function(r){r.forEach(function(r){if("attributes"===r.type&&("style"===r.attributeName||"hidden"===r.attributeName)){M.util.js_pending(o);if(-1<a.EMPTY_CONTENT.indexOf(n("#"+i).html())){t.triggerAttoNoContent(e)}else{t.triggerAttoHasContent(e)}M.util.js_complete(o)}})});l.observe(d,{attributes:!0,childList:!0,subtree:!0});r.change(function(){M.util.js_pending(o);if(-1<a.EMPTY_CONTENT.indexOf(n("#"+i).html())){t.triggerAttoNoContent(e)}else{t.triggerAttoHasContent(e)}M.util.js_complete(o)});M.util.js_complete("init_editor");var E=setInterval(function(){e.find("textarea[id^=\"id_message\"]").trigger("change")},350);setTimeout(function(){clearInterval(E)},5e3)},checkEmptyElement:function checkEmptyElement(e){return 0===e.children().length},setHasComment:function setHasComment(e){var t=this,o=n(a.SELECTOR.CONTAINER),r=a.HAS_COMMENT_CLASS;if(!t.forceCommenting){t.hasComment=!0;o.addClass(r)}else{t.hasComment=e;if(t.hasComment){o.addClass(r)}else{o.removeClass(r)}}},parseQueryString:function parseQueryString(e){for(var t=e.split("&"),n={},o=0;o<t.length;o++){var r=t[o].split("="),d=decodeURIComponent(r[0]),l=decodeURIComponent(r[1]);if("undefined"==typeof n[d]){n[d]=decodeURIComponent(l)}else if("string"==typeof n[d]){n[d]=[n[d],decodeURIComponent(l)]}else{n[d].push(decodeURIComponent(l))}}return n},scrollToElement:function scrollToElement(e,t){if(!e.length){return}if("undefined"==typeof t){t=1e3}var o=e.offset().top;n("html,body").animate({scrollTop:o},t)},buildRefererReportLink:function buildRefererReportLink(e,t){var n=this,o=decodeURIComponent(n.referer);e+="&referer="+encodeURIComponent(o+"&highlight="+t);return e},triggerAttoHasContent:function triggerAttoHasContent(e){var t=e.find(a.SELECTOR.ATTO.CONTENT_WRAP),n=e.find(a.SELECTOR.SUBMIT_BUTTON);n.removeClass("disabled");n.prop("disabled",!1);t.attr("data-placeholder","")},triggerAttoNoContent:function triggerAttoNoContent(e){var t=e.attr("data-textarea-placeholder"),n=e.find(a.SELECTOR.ATTO.CONTENT_WRAP),o=e.find(a.SELECTOR.SUBMIT_BUTTON);o.addClass("disabled");o.prop("disabled",!0);n.attr("data-placeholder",t)},setSort:function setSort(e){var t=this;if(-1!==n.inArray(e,t.sortable)){t.sortFeature=e}}}},generate:function generate(e){a.get().init(JSON.parse(e))}};return a});
//# sourceMappingURL=comment_area.min.js.map
